name: Flutter Firebase CI/CD with Backup Recovery (RTDB + Auth)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily backup at 2 AM

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # Job 1: Build and Test
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze

      - name: Run tests
        run: flutter test --coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

      - name: Build APK
        run: flutter build apk --release

      - name: Build App Bundle
        run: flutter build appbundle --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Upload App Bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-bundle
          path: build/app/outputs/bundle/release/app-release.aab

  # Job 2: Firebase Backup (RTDB + Auth)
  firebase-backup:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'schedule' || github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Create backup directory
        run: mkdir -p backups

      - name: Backup Realtime Database
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "Creating RTDB backup: rtdb-backup-$TIMESTAMP.json"
          
          # Export Realtime Database via REST API
          curl -X GET \
            "https://${{ secrets.FIREBASE_PROJECT_ID }}-default-rtdb.firebaseio.com/.json?auth=${{ secrets.FIREBASE_DATABASE_SECRET }}" \
            -o backups/rtdb-backup-$TIMESTAMP.json
          
          # Verify backup is valid JSON
          if jq empty backups/rtdb-backup-$TIMESTAMP.json 2>/dev/null; then
            echo "âœ… RTDB backup created successfully"
            echo "Backup size: $(du -h backups/rtdb-backup-$TIMESTAMP.json | cut -f1)"
          else
            echo "âŒ RTDB backup failed - invalid JSON"
            exit 1
          fi

      - name: Backup Firebase Auth Users
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "Creating Auth backup: auth-backup-$TIMESTAMP.json"
          
          # Authenticate Firebase
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > service-account.json
          export GOOGLE_APPLICATION_CREDENTIALS=service-account.json
          
          # Export auth users
          firebase auth:export backups/auth-backup-$TIMESTAMP.json \
            --project ${{ secrets.FIREBASE_PROJECT_ID }}
          
          if [ -f backups/auth-backup-$TIMESTAMP.json ]; then
            echo "âœ… Auth backup created successfully"
            echo "Backup size: $(du -h backups/auth-backup-$TIMESTAMP.json | cut -f1)"
          else
            echo "âŒ Auth backup failed"
            exit 1
          fi
          
          rm service-account.json

      - name: Upload backups to GitHub
        run: |
          # Create backups branch if it doesn't exist
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git checkout -B backups || git checkout backups
          
          # Copy backups
          mkdir -p firebase-backups/rtdb
          mkdir -p firebase-backups/auth
          
          cp backups/rtdb-backup-*.json firebase-backups/rtdb/
          cp backups/auth-backup-*.json firebase-backups/auth/
          
          # Keep only last 30 backups
          cd firebase-backups/rtdb && ls -t | tail -n +31 | xargs -r rm
          cd ../auth && ls -t | tail -n +31 | xargs -r rm
          cd ../..
          
          git add firebase-backups/
          git commit -m "Automated backup - $(date)" || echo "No changes to commit"
          git push origin backups --force

      - name: Create backup archive
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          tar -czf backup-complete-$TIMESTAMP.tar.gz backups/
          echo "âœ… Backup archive created: backup-complete-$TIMESTAMP.tar.gz"

      - name: Upload backup archive as artifact
        uses: actions/upload-artifact@v4
        with:
          name: firebase-backup-${{ github.run_number }}
          path: backup-complete-*.tar.gz
          retention-days: 30

      - name: Generate backup report
        run: |
          cat > backup-report.txt << EOF
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Firebase Backup Report
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Date: $(date)
          Repository: ${{ github.repository }}
          Commit: ${{ github.sha }}
          
          Realtime Database Backup:
          $(ls -lh backups/rtdb-backup-*.json)
          
          Auth Users Backup:
          $(ls -lh backups/auth-backup-*.json)
          
          Total Backup Size:
          $(du -sh backups/ | cut -f1)
          
          Backup Location: GitHub Actions Artifacts
          Retention: 30 days
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          
          cat backup-report.txt

      - name: Send backup notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: âœ… Firebase Backup Successful - ${{ github.repository }}
          body: file://backup-report.txt
          to: ${{ secrets.NOTIFICATION_EMAIL }}

      - name: Send failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: âŒ Firebase Backup FAILED - ${{ github.repository }}
          body: |
            Firebase backup failed!
            
            Repository: ${{ github.repository }}
            Workflow: ${{ github.workflow }}
            Run: ${{ github.run_number }}
            
            Please check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}

  # Job 3: Deploy APK to Firebase App Distribution
  deploy-android:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: release-apk

      - name: Deploy to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          groups: testers
          file: app-release.apk
          releaseNotes: |
            ğŸš€ Automated release from commit: ${{ github.sha }}
            ğŸ“± Branch: ${{ github.ref_name }}
            ğŸ‘¤ Author: ${{ github.actor }}
            ğŸ“… Date: ${{ github.event.head_commit.timestamp }}

  # Job 4: Disaster Recovery Test
  disaster-recovery-test:
    runs-on: ubuntu-latest
    needs: firebase-backup
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout backups branch
        run: |
          git fetch origin backups:backups || echo "Backups branch not found"
          git checkout backups || echo "No backups yet"

      - name: Verify RTDB backup integrity
        run: |
          echo "Testing RTDB backup integrity..."
          LATEST_RTDB=$(ls -t firebase-backups/rtdb/rtdb-backup-*.json 2>/dev/null | head -1)
          
          if [ -z "$LATEST_RTDB" ]; then
            echo "âŒ No RTDB backup found"
            exit 1
          fi
          
          echo "Latest RTDB backup: $LATEST_RTDB"
          
          # Validate JSON
          if jq empty "$LATEST_RTDB" 2>/dev/null; then
            echo "âœ… RTDB backup is valid JSON"
            echo "Backup size: $(du -h $LATEST_RTDB | cut -f1)"
            echo "Records: $(jq 'keys | length' $LATEST_RTDB)"
          else
            echo "âŒ RTDB backup is corrupted"
            exit 1
          fi

      - name: Verify Auth backup integrity
        run: |
          echo "Testing Auth backup integrity..."
          LATEST_AUTH=$(ls -t firebase-backups/auth/auth-backup-*.json 2>/dev/null | head -1)
          
          if [ -z "$LATEST_AUTH" ]; then
            echo "âŒ No Auth backup found"
            exit 1
          fi
          
          echo "Latest Auth backup: $LATEST_AUTH"
          
          # Validate JSON
          if jq empty "$LATEST_AUTH" 2>/dev/null; then
            echo "âœ… Auth backup is valid JSON"
            echo "Backup size: $(du -h $LATEST_AUTH | cut -f1)"
            echo "Users: $(jq '.users | length' $LATEST_AUTH)"
          else
            echo "âŒ Auth backup is corrupted"
            exit 1
          fi

      - name: Test backup age (ensure recent)
        run: |
          LATEST_RTDB=$(ls -t firebase-backups/rtdb/rtdb-backup-*.json 2>/dev/null | head -1)
          
          if [ -n "$LATEST_RTDB" ]; then
            BACKUP_AGE=$(($(date +%s) - $(stat -c %Y "$LATEST_RTDB")))
            HOURS=$((BACKUP_AGE / 3600))
          
            echo "Last backup was $HOURS hours ago"
          
            if [ $HOURS -gt 48 ]; then
              echo "âš ï¸  WARNING: Backup is older than 48 hours!"
            else
              echo "âœ… Backup is recent"
            fi
          fi

      - name: Generate recovery test report
        run: |
          cat > recovery-test-report.txt << EOF
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Disaster Recovery Test Report
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Date: $(date)
          Status: ${{ job.status }}
          
          RTDB Backup Status: âœ… Valid
          Auth Backup Status: âœ… Valid
          
          Latest Backups:
          - RTDB: $(ls -t firebase-backups/rtdb/*.json 2>/dev/null | head -1 | xargs basename)
          - Auth: $(ls -t firebase-backups/auth/*.json 2>/dev/null | head -1 | xargs basename)
          
          All recovery points verified successfully.
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          
          cat recovery-test-report.txt

      - name: Send recovery test notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ğŸ”„ Disaster Recovery Test - ${{ job.status }}
          body: file://recovery-test-report.txt
          to: ${{ secrets.NOTIFICATION_EMAIL }}